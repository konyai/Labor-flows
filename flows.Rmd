---
title: "Labor market"
author: "Istvan Konya"
output: html_document
---

## Introduction

Start with some basic housekeeping: load packages, define colors.

```{r include=FALSE}

library(tidyverse)
library(eurostat)
library(zoo)

# Define my favorite color scheme
col1 = "#013C58"
col3 = "#800000"
col2 = "#E69C38"
col5 = "#808000"
col4 = "#C0C0C0"
col6 = "#7093DB"
cols = c(col1,col2,col3,col4,col5,col6)

eu <- c("AT","BE","DK","DE","EL","ES","FR","IT","CY","MT","NL","PT","FI","SE",
        "CZ","HU","PL","SK","RO","BG","SI","HR","EE","LT","LV","LU","IE")
```

## Labor market data

Labor market stocks, seasonally adjusted. Since inactivity is not seasonally adjusted, calculate it from adjusted employment and unemployment, and unadjusted population data.

```{r warning=FALSE, message=FALSE}

stock <- get_eurostat("lfsi_emp_q", filters = list(geo=eu,unit="THS_PER",sex="T",age="Y15-74",
                                                   s_adj="NSA"))
stock <- stock %>% pivot_wider(id_cols=c(geo,time),names_from=indic_em,values_from = values)
stock$time <- as.yearqtr(stock$time)
stock <- stock %>% mutate(une = ACT-EMP_LFS) %>% select(geo,time,une,emp=EMP_LFS)

pop <- get_eurostat("lfsq_pganws", filters = list(geo=eu,sex="T",age="Y15-74",wstatus="POP",
                                                   citizen="TOTAL"))
pop <- pop %>% select(geo,time,pop=values)
pop$time <- as.yearqtr(pop$time)

stock <- stock %>% left_join(pop)
stock <- stock %>% filter(time > "2008 Q4")
stock <- stock %>% mutate(ina=pop-emp-une)
```

Recent job leavers (s.a.). Merge with stocks.

```{r warning=FALSE, message=FALSE}

rjl <- get_eurostat("lfsi_lea_q",
                    filters = list(geo=eu,s_adj="NSA",age="Y15-74",sex="T",unit="THS"))
rjl <- rjl %>% select(geo,time,rjl=values)
rjl$time <- as.yearqtr(rjl$time)
df <- left_join(stock,rjl)
```

Recent job starters (s.a.). Merge with stocks.

```{r warning=FALSE, message=FALSE}

rjs <- get_eurostat("lfsi_sta_q",
                    filters = list(geo=eu,age="Y15-74",sex="T",s_adj="NSA",unit="THS"))
rjs <- rjs %>% select(geo,time,rjs=values)
rjs$time <- as.yearqtr(rjs$time)
df <- left_join(df,rjs)
```

Labor market transitions

```{r warning=FALSE, message=FALSE}

tran <- get_eurostat("lfsi_long_q",
                     filters = list(unit = "THS_PER", s_adj = "NSA", geo = eu,
                                    sex = "T"))
tran$time <- as.yearqtr(tran$time)
tran <- tran %>% pivot_wider(id_cols=c(geo,time),names_from="indic_em",values_from=values)
tran <- tran %>% filter(time > "2007 Q4")
```

Download duration and tenure data from the detailed quarterly tables

```{r warning=FALSE, message=FALSE}

dur <- get_eurostat("lfsq_ugad", filters = list(geo=eu,duration=c("M_LT1","M1-2"),
                                                age="Y15-74",sex="T"))
dur <- dur %>% pivot_wider(id_cols = c(geo,time), names_from = duration,
                           values_from = values)
dur <- dur %>% mutate(unes = `M_LT1`+`M1-2`) %>% select(geo,time,unes)
dur$time <- as.yearqtr(dur$time)

ten <- get_eurostat("lfsq_egdn2", filters = list(geo=eu,duration="M_LT3",nace_r2="TOTAL",
                                                age="Y15-74",sex="T"))
ten <- ten %>% select(geo,time,emps = values)
ten$time <- as.yearqtr(ten$time)

df <- df %>% left_join(dur)
df <- df %>% left_join(ten)
```

## Various checks

Check that transitions and stocks data are consistent

```{r warning=FALSE, message=FALSE}

tran <- tran %>% mutate(E = E_E+U_E+I_E, lagE = E_E+E_U+E_I,
                        U = U_U+E_U+I_U, lagU = U_U+U_E+U_I,
                        I = I_I+E_I+U_I, lagI = I_I+I_E+I_U)
stock <- tran %>% select(geo,time,E,U,I,lagE,lagU,lagI) %>% right_join(stock)
stock %>% filter(geo=="HU") %>% select(time,E,emp) %>%
  pivot_longer(cols = -time,names_to = "var", values_to = "val") %>%
  ggplot() + geom_line(aes(x=time,y=val,color=var))
```

Recent job starters against short-duration employment. These are the same series!

```{r warning=FALSE, message=FALSE}

df %>% filter(geo=="HU") %>% ggplot() + geom_line(aes(x=time,y=rjs),color=col1) +
  geom_line(aes(x=time,y=emps),color=col2)
```

Recent job leavers are those who lost their jobs and did not immediately started a new one. Time aggregation complicates matters, because they might have found a new one in a quarter.

Plot recent job leavers against those who transitioned from employment into unemployment or inactivity.

```{r message=FALSE, warning=FALSE}

ggplot() + geom_line(data=df[df$geo=="HU",],aes(x=time,y=rjl),color=col1) +
  geom_line(data=tran[tran$geo=="HU",],aes(x=time,y=E_I),color=col2)
```

## Calculations

Convert all variables to rates first. No need to worry about time aggregation for these rates, only for the complementary ones.

```{r warning=FALSE, message=FALSE}

df <- df %>% mutate(er = emp/pop, ur = une/pop, ir = ina/pop, esr = emps/pop, usr = unes/pop)
df <- df %>% select(geo,time,er,ur,ir,esr,usr)
df <- df %>% group_by(geo) %>% mutate(u_out = 1-(ur-usr)/lag(ur), e_out = 1-(er-esr)/lag(er))
tran <- tran %>% group_by(geo) %>% mutate(u_out_tr = (U_E+U_I)/(U_E+U_I+U_U),
                        e_out_tr = (E_U+E_I)/(E_E+E_I+E_U))
```

Now compute the same measures using transitions data.

```{r warning=FALSE, message=FALSE}

ggplot() + geom_line(data=df[df$geo=="FR",],aes(x=time,y=u_out),color=col1) +
  geom_line(data=tran[tran$geo=="FR",],aes(x=time,y=u_out_tr),color=col2)
```
